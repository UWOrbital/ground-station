name: Pytest

on: [push, pull_request]

jobs:
  pytest:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.12']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        cd backend
        sudo apt update
        sudo apt install -y postgresql
        python -m pip install --upgrade pip uv
        uv sync

    - name: Set up PostgreSQL database
      run: |
        cd backend
        sudo service postgresql start
        sudo -u postgres psql -c "CREATE USER ci_user WITH PASSWORD 'ci_password' SUPERUSER;"
        sudo -u postgres psql -c "CREATE DATABASE gs;"

    - name: Create CI .env file
      run: |
        cd backend
        cat > .env << EOF
        GS_DATABASE_USER=ci_user
        GS_DATABASE_PASSWORD=ci_password
        GS_DATABASE_LOCATION=localhost
        GS_DATABASE_PORT=5432
        GS_DATABASE_NAME=gs
        EOF

    - name: Run Alembic migrations
      run: |
        cd backend
        uv run alembic upgrade head

    - name: Run pytest
      env:
        GS_DATABASE_USER: ci_user
        GS_DATABASE_PASSWORD: ci_password
        GS_DATABASE_LOCATION: localhost
        GS_DATABASE_PORT: 5432
        GS_DATABASE_NAME: gs
      run: |
        cd backend
        uv run pytest
